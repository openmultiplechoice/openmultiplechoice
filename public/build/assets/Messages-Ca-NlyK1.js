import{d as Ot,p as Ht,m as G,b as P,h as i,i as Nt,f,j as s,c as n,w as d,s as V,t as N,g as h,k as ut,a as g,o as ht,n as Ct,q as Mt}from"./render-COO8opCt.js";import{i as b}from"./if-CwjDoZzt.js";import{e as Gt,i as ne,p as ie}from"./event-modifiers-BGh6mCkd.js";import{s as Et,d as Lt,a as Tt,b as re}from"./attributes-DYipTw7O.js";import{s as D}from"./class-BfJg_ovI.js";import{s as At}from"./style-BtOSwUPa.js";import{p as Pt,s as oe,a as de}from"./props-B2c_TekP.js";import{r as ue}from"./legacy-client-30PpYn5B.js";import{K as tt,p as le,d as ce}from"./hotkeys-js-Bzouew-W.js";import{h as ve}from"./html-DHpoEShY.js";import{U as me}from"./UserSettingsStore-BhoajYbS.js";import{f as jt,p as It}from"./parseISO-NWqeT_ov.js";import{f as _e}from"./formatDistance-C_vtkNGs.js";var be=f('<div class="p-2"><span class="text-muted small"><i class="bi bi-trash me-1"></i>This comment has been deleted.</span></div>'),fe=f('<div class="p-2"><button class="btn btn-link btn-sm text-muted p-0"><i class="bi bi-eye-slash me-1"></i>Comment hidden due to low rating. Click to show.</button></div>'),pe=f('<i class="bi bi-arrow-return-right" title="Answer"></i> <span>•</span>',1),he=f('<i class="bi bi-incognito" title="Anonymous"></i>'),ge=f('<i class="bi bi-pencil ms-1"></i>'),ye=f('<div class="trix-content pe-4"><!></div>'),xe=f('<div class="pe-2"><input id="message" type="hidden" name="message"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous"/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),we=f('<div class="dropdown"><button class="btn btn-link p-0 text-muted me-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button> <ul class="dropdown-menu dropdown-menu-end"><li><button class="dropdown-item btn btn-sm"><i class="bi bi-pencil me-2"></i>Edit</button></li> <li><button class="dropdown-item btn btn-sm"><i class="bi bi-trash me-2"></i>Delete</button></li></ul></div>'),ke=f('<div class="d-flex align-items-end gap-2 pe-1"><button title="Reply"><i class="bi bi-reply"></i></button> <!></div>'),Me=f('<div><div class="d-flex flex-column gap-1" style="min-width: 2rem"><button><i></i></button> <span class="text-center text-muted small"> </span> <button><i></i></button></div> <div class="flex-grow-1"><div class="d-flex gap-2 text-muted small"><!> <span><!></span> <span>•</span> <span> <!></span></div> <div class="mt-1"><!></div></div> <!></div>'),Ie=f('<i class="bi bi-incognito" title="Anonymous"></i>'),Ee=f('<div class="border-start border-2 my-2 ms-2 ps-2"><div class="d-flex gap-2 text-muted small mb-2"><i class="bi bi-arrow-return-right" title="Answer"></i> Replying to <!></div> <div><input id="replyMessage" type="hidden" name="replyMessage"/> <input id="parentMessageId" type="hidden" name="parentMessageId"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between"><div class="form-check"><input type="checkbox" class="form-check-input" id="replyAnonymous" checked/> <label class="form-check-label small" for="replyAnonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Reply</button></div></div></div></div>',2),Ae=f("<div><!> <!> <!></div>");function Ut(gt,c){Ht(c,!0);const U=()=>de(me,"$UserSettings",R),[R,Y]=oe();let t=Pt(c,"message",15),_=ut(()=>t().thumbs.find(a=>a.user_id!==void 0)??null),W=ut(()=>t().thumbs_up_count-t().thumbs_down_count>4),F=ut(()=>t().thumbs_up_count-t().thumbs_down_count<-2);var z=V(!1),B=V(!1),et=V(!1);function at(){g(z,!d(z)),d(z)?tt.setScope("editor"):tt.setScope("questions")}function J(){g(B,!d(B)),d(B)?tt.setScope("editor"):tt.setScope("questions")}function yt(){g(et,!d(et))}function st(){var a={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.put("/api/messages/"+t().id,a).then(function(e){at(),t(t().text=e.data.text,!0),t(t().is_anonymous=e.data.is_anonymous,!0),t(t().updated_at=e.data.updated_at,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function lt(){var a={text:document.getElementById("replyMessage").value,parent_message_id:document.getElementById("parentMessageId").value,is_anonymous:document.getElementById("replyAnonymous").checked};axios.post("/api/questions/"+c.questionId+"/messages",a).then(function(e){J(),c.addMessage(e.data)}).catch(function(e){alert(e)})}function xt(){confirm("Are you sure you want to delete this message?")&&axios.delete("/api/messages/"+t().id).then(function(a){t(t().text="",!0),t(t().is_deleted=!0,!0),c.updateMessage(t())}).catch(function(a){alert(a)})}function ct(a){h(_)!==null?h(_).type===a?axios.delete("/api/messages/"+t().id+"/thumbs/"+h(_).id).then(function(e){t(t().thumbs=t().thumbs.filter(r=>r.user_id===void 0),!0),t(a==="up"?t().thumbs_up_count-=1:t().thumbs_down_count-=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.put("/api/messages/"+t().id+"/thumbs/"+h(_).id,{type:a}).then(function(e){t().thumbs.find(r=>r.user_id!==void 0).type=a,a==="up"?(t(t().thumbs_up_count+=1,!0),t(t().thumbs_down_count-=1,!0)):(t(t().thumbs_down_count+=1,!0),t(t().thumbs_up_count-=1,!0)),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.post("/api/messages/"+t().id+"/thumbs",{type:a}).then(function(e){t().thumbs.push({type:e.data.type,user_id:e.data.user_id,id:e.data.id}),t(a==="up"?t().thumbs_up_count+=1:t().thumbs_down_count+=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function l(a){return Array.isArray(a.childs)?a.childs.some(e=>!e.is_deleted||l(e)):!1}var u=G(),v=P(u);{var X=a=>{var e=Ae();let r;var y=s(e);{var E=p=>{var w=be();i(p,w)},x=p=>{var w=G(),T=P(w);{var it=q=>{var j=fe(),K=s(j);K.__click=yt,i(q,j)},rt=q=>{var j=Me(),K=s(j),L=s(K);let vt;L.__click=()=>ct("up");var wt=s(L);let ot;var mt=n(L,2),O=s(mt),H=n(mt,2);let _t;H.__click=()=>ct("down");var kt=s(H);let $;var dt=n(K,2),qt=s(dt),St=s(qt);{var Yt=o=>{var m=pe();i(o,m)};b(St,o=>{c.indent>0&&o(Yt)})}var Dt=n(St,2),zt=s(Dt);{var Kt=o=>{var m=he();i(o,m)},Qt=o=>{var m=G(),k=P(m);{var M=I=>{var S=Ct();N(()=>ht(S,t().author.public_name||t().author.name)),i(I,S)};b(k,I=>{t().author&&I(M)},!0)}i(o,m)};b(zt,o=>{t().is_anonymous?o(Kt):o(Qt,!1)})}var Rt=n(Dt,4),Bt=s(Rt),Vt=n(Bt);{var Wt=o=>{var m=ge();N(k=>Tt(m,"title",k),[()=>"Edited "+jt(It(t().updated_at),"dd.MM.yyyy HH:mm")]),i(o,m)};b(Vt,o=>{t().updated_at!==t().created_at&&o(Wt)})}var Ft=n(qt,2),Jt=s(Ft);{var Xt=o=>{var m=ye(),k=s(m);{var M=I=>{var S=G(),Q=P(S);ve(Q,()=>le.sanitize(t().text)),i(I,S)};b(k,I=>{t().text&&I(M)})}i(o,m)},Zt=o=>{var m=xe(),k=s(m),M=n(k,2);Et(M,"input","message"),D(M,1,"trix-content form-control mb-2"),At(M,"min-height: 4rem;");var I=n(M,2),S=s(I),Q=s(S),bt=n(S,2),ft=s(bt);ft.__click=at;var pt=n(ft,2);pt.__click=st,N(()=>{Lt(k,t().text),re(Q,t().is_anonymous)}),i(o,m)};b(Jt,o=>{d(z)?o(Zt,!1):o(Xt)})}var $t=n(dt,2);{var te=o=>{var m=ke(),k=s(m);let M;k.__click=J;var I=n(k,2);{var S=Q=>{var bt=we(),ft=n(s(bt),2),pt=s(ft),ee=s(pt);ee.__click=at;var ae=n(pt,2),se=s(ae);se.__click=xt,i(Q,bt)};b(I,Q=>{U().id===t().author_id&&Q(S)})}N(()=>M=D(k,1,"btn btn-link p-0 text-muted me-1",null,M,{disabled:d(B)})),i(o,m)};b($t,o=>{d(z)||o(te)})}N((o,m)=>{D(j,1,`d-flex gap-1 mb-2 message-content ${h(W)?"bg-light rounded-end-3 shadow-sm py-2 ps-1 pe-2 ms-1":"py-1 rounded-end-3"}`),vt=D(L,1,"btn btn-link p-0 text-muted text-decoration-none",null,vt,{disabled:t().is_deleted}),ot=D(wt,1,"bi",null,ot,{"bi-hand-thumbs-up-fill":h(_)?.type==="up","bi-hand-thumbs-up":h(_)?.type!=="up"}),ht(O,t().thumbs_up_count-t().thumbs_down_count),_t=D(H,1,"btn btn-link p-0 text-muted text-decoration-none",null,_t,{disabled:t().is_deleted}),$=D(kt,1,"bi",null,$,{"bi-hand-thumbs-down-fill":h(_)?.type==="down","bi-hand-thumbs-down":h(_)?.type!=="down"}),Tt(Rt,"title",o),ht(Bt,`${m??""} `)},[()=>jt(It(t().created_at),"dd.MM.yyyy HH:mm"),()=>_e(It(t().created_at),new Date,{addSuffix:!0})]),i(q,j)};b(T,q=>{h(F)&&!d(et)?q(it):q(rt,!1)},!0)}i(p,w)};b(y,p=>{t().is_deleted?p(E):p(x,!1)})}var Z=n(y,2);{var A=p=>{var w=Ee(),T=s(w),it=n(s(T),2);{var rt=O=>{var H=Ie();i(O,H)},q=O=>{var H=G(),_t=P(H);{var kt=$=>{var dt=Ct();N(()=>ht(dt,t().author.public_name||t().author.name)),i($,dt)};b(_t,$=>{t().author&&$(kt)},!0)}i(O,H)};b(it,O=>{t().is_anonymous?O(rt):O(q,!1)})}var j=n(T,2),K=n(s(j),2),L=n(K,2);Et(L,"input","replyMessage"),D(L,1,"trix-content form-control mb-2"),At(L,"min-height: 4rem;");var vt=n(L,2),wt=n(s(vt),2),ot=s(wt);ot.__click=J;var mt=n(ot,2);mt.__click=lt,N(()=>Lt(K,t().id)),i(p,w)};b(Z,p=>{d(B)&&p(A)})}var C=n(Z,2);{var nt=p=>{var w=G(),T=P(w);Gt(T,17,()=>t().childs,ne,(it,rt)=>{{let q=ut(()=>c.indent+1);Ut(it,{get message(){return h(rt)},get indent(){return h(q)},get addMessage(){return c.addMessage},get updateMessage(){return c.updateMessage},get questionId(){return c.questionId}})}}),i(p,w)};b(C,p=>{t().childs&&p(nt)})}N(()=>r=D(e,1,"border-start border-2",null,r,{"ms-2":c.indent>0,"mb-3":!c.indent})),i(a,e)};b(v,a=>{(!t().is_deleted||l(t()))&&a(X)})}i(gt,u),Nt(),Y()}Ot(["click"]);var qe=f('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading messages ...</span></div>'),Se=f('<div class="text-muted">No comments yet. Be the first to leave a comment!</div>'),De=f('<div class="mb-3 d-flex justify-content-center"><!></div>'),Re=f('<div class="mt-3 border-top border-2 pt-3"><input id="message" type="hidden" name="message" value=""/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous" checked/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Be=f('<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-chat-square-text"></i> Add comment</button>'),Ce=f('<div class="mt-4 mb-3 px-2 py-2 border rounded-3 shadow-sm bg-white"><!> <!></div>');function Ve(gt,c){Ht(c,!0);const U={LOADING:"loading",EMPTY:"empty"};let R=Pt(c,"questionId",15);var Y=V(!1),t=V(Mt([])),_=V(Mt([])),W=V(Mt(U.LOADING));ue(()=>{R(),g(_,[],!0),g(Y,!1),z()});var F;function z(){g(t,[],!0),g(W,U.LOADING,!0),F&&F.cancel();const l=R();F=ce(()=>{axios.get("/api/questions/"+R()+"/messages").then(function(u){if(l===R()){if(g(t,u.data,!0),d(t).filter(v=>!v.is_deleted).length===0){g(_,[],!0),g(W,U.EMPTY,!0);return}g(_,B(d(t)),!0)}}).catch(function(u){alert(u)})},1e3,{maxWait:2e3}),F()}function B(l){var u={},v=[];l.forEach(a=>{if(!a.parent_message_id&&!a.legacy_parent_message_id){v.push(a);return}var e=a.parent_message_id;if(!e){const r=l.find(y=>y.legacy_message_id===a.legacy_parent_message_id);r?e=r.id:console.error("Parent message not found for message",a)}u[e]||(u[e]=[]),u[e].push(a)}),Object.values(u).forEach(a=>{a.sort((e,r)=>r.thumbs_up_count-r.thumbs_down_count-(e.thumbs_up_count-e.thumbs_down_count))}),v.sort((a,e)=>e.thumbs_up_count-e.thumbs_down_count-(a.thumbs_up_count-a.thumbs_down_count));function X(a){var e=a.id;u[e]&&(a.childs=u[e],a.childs.forEach(r=>{X(r)}))}return v.forEach(a=>{X(a)}),v}function et(l){d(t).push(l),g(_,B(d(t)),!0)}function at(l){const u=d(t).findIndex(v=>v.id===l.id);d(t)[u]=l,g(_,J(d(_),l),!0)}function J(l,u){return l.map(v=>v.id===u.id?{...u,childs:v.childs}:v.childs?{...v,childs:J(v.childs,u)}:v)}function yt(){var l={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.post("/api/questions/"+R()+"/messages",l).then(function(u){st(),d(t).push(u.data),g(_,B(d(t)),!0)}).catch(function(u){alert(u)})}function st(){g(Y,!d(Y)),d(Y)?tt.setScope("editor"):tt.setScope("questions")}var lt=G(),xt=P(lt);{var ct=l=>{var u=Ce(),v=s(u);Gt(v,19,()=>d(_),r=>r.id,(r,y,E)=>{Ut(r,{indent:0,addMessage:et,updateMessage:at,get message(){return d(_)[h(E)]},set message(x){d(_)[h(E)]=x},get questionId(){return R()},set questionId(x){R(x)}})},r=>{var y=De(),E=s(y);{var x=A=>{var C=qe();i(A,C)},Z=A=>{var C=G(),nt=P(C);{var p=w=>{var T=Se();i(w,T)};b(nt,w=>{d(W)===U.EMPTY&&w(p)},!0)}i(A,C)};b(E,A=>{d(W)===U.LOADING?A(x):A(Z,!1)})}i(r,y)});var X=n(v,2);{var a=r=>{var y=Re(),E=s(y),x=n(E,2);Et(x,"input","message"),D(x,1,"trix-content form-control mb-2"),At(x,"min-height: 4rem;");var Z=n(x,2),A=n(s(Z),2),C=s(A);C.__click=st;var nt=n(C,2);nt.__click=yt,i(r,y)},e=r=>{var y=Be(),E=ut(()=>ie(st));y.__click=function(...x){h(E)?.apply(this,x)},i(r,y)};b(X,r=>{d(Y)?r(a):r(e,!1)})}i(l,u)};b(xt,l=>{c.questionContext.isAnswered&&l(ct)})}i(gt,lt),Nt()}Ot(["click"]);export{Ve as M};
