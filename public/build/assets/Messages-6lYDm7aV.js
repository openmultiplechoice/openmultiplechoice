import{p as Qt,l as It,h as x,m as Q,k as s,a as Vt,i as Wt,n as Y,b as z,c as p,u,d as i,e as Ft,f as h,g as q,v as f,j as n,s as o,t as J,y as ve,o as Pt,w as me}from"./lifecycle-BvmTvt_c.js";import{e as E,s as Bt,g as Ut,b as Jt,i as _e,c as kt,a as Gt,d as be,p as pe}from"./event-modifiers-C9-V6teM.js";import{p as tt,b as fe,s as L,a as he}from"./props-DkMS-7Z0.js";import{s as Tt}from"./style-BxdPOk1g.js";import{p as Yt,d as ge}from"./purify.es-Dnvgf1Dd.js";import{h as ye}from"./html-DWUw1S_J.js";import{U as xe}from"./UserSettingsStore-CgXksdE5.js";import{f as Mt,p as ot}from"./parseISO-BjONWRSE.js";import{f as zt}from"./formatDistance-DD1FqeGq.js";var we=h('<div class="p-2"><button class="btn btn-link btn-sm text-muted p-0"><i class="bi bi-eye-slash me-1"></i>Comment hidden due to low rating. Click to show.</button></div>'),ke=h('<div class="p-2"><span class="text-muted small"><i class="bi bi-trash me-1"></i>This comment has been deleted.</span></div>'),Me=h('<i class="bi bi-arrow-return-right" title="Answer"></i> <span>•</span>',1),Ie=h('<i class="bi bi-incognito" title="Anonymous"></i>'),Ee=h('<i class="bi bi-pencil ms-1"></i>'),Ae=h('<div class="trix-content pe-4"><!></div>'),qe=h('<div class="pe-2"><input id="message" type="hidden" name="message"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous"/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Se=h('<div class="dropdown"><button class="btn btn-link p-0 text-muted me-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button> <ul class="dropdown-menu dropdown-menu-end"><li><button class="dropdown-item"><i class="bi bi-pencil me-2"></i>Edit</button></li> <li><button class="dropdown-item"><i class="bi bi-trash me-2"></i>Delete</button></li></ul></div>'),Ce=h('<div class="d-flex align-items-end gap-2 pe-1"><button title="Reply"><i class="bi bi-reply"></i></button> <!></div>'),De=h('<div><div class="d-flex flex-column gap-1" style="min-width: 2rem"><button><i></i></button> <span class="text-center text-muted small"> </span> <button><i></i></button></div> <div class="flex-grow-1"><div class="d-flex gap-2 text-muted small"><!> <span><!></span> <span>•</span> <span> <!></span></div> <div class="mt-1"><!></div></div> <!></div>'),Re=h('<i class="bi bi-incognito" title="Anonymous"></i>'),Be=h('<div class="border-start border-2 my-2 ms-2 ps-2"><div class="d-flex gap-2 text-muted small mb-2"><i class="bi bi-arrow-return-right" title="Answer"></i> Replying to <!></div> <div><input id="replyMessage" type="hidden" name="replyMessage"/> <input id="parentMessageId" type="hidden" name="parentMessageId"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between"><div class="form-check"><input type="checkbox" class="form-check-input" id="replyAnonymous" checked/> <label class="form-check-label small" for="replyAnonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Reply</button></div></div></div></div>',2),Te=h("<div><!> <!> <!></div>");function Kt(Et,R){Qt(R,!1);const S=()=>he(xe,"$UserSettings",_t),[_t,et]=fe(),m=Q(),w=Q(),j=Q();let t=tt(R,"message",12),H=tt(R,"indent",8),bt=tt(R,"addMessage",8),B=tt(R,"updateMessage",8),pt=tt(R,"questionId",8);var at=Q(!1),K=Q(!1),dt=Q(!1);function X(){x(at,!f(at))}function st(){x(K,!f(K))}function At(){x(dt,!f(dt))}function qt(){var e={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.put("/api/messages/"+t().id,e).then(function(a){X(),t(t().text=a.data.text,!0),t(t().is_anonymous=a.data.is_anonymous,!0),t(t().updated_at=a.data.updated_at,!0),B()(t())}).catch(function(a){alert(a)})}function b(){var e={text:document.getElementById("replyMessage").value,parent_message_id:document.getElementById("parentMessageId").value,is_anonymous:document.getElementById("replyAnonymous").checked};axios.post("/api/questions/"+pt()+"/messages",e).then(function(a){st(),bt()(a.data)}).catch(function(a){alert(a)})}function v(){confirm("Are you sure you want to delete this message?")&&axios.delete("/api/messages/"+t().id).then(function(e){t(t().text="",!0),t(t().is_deleted=!0,!0),B()(t())}).catch(function(e){alert(e)})}function l(e){q(m)!==null?q(m).type===e?axios.delete("/api/messages/"+t().id+"/thumbs/"+q(m).id).then(function(a){t(t().thumbs=t().thumbs.filter(g=>g.user_id===void 0),!0),t(e==="up"?t().thumbs_up_count-=1:t().thumbs_down_count-=1,!0),B()(t())}).catch(function(a){alert(a)}):axios.put("/api/messages/"+t().id+"/thumbs/"+q(m).id,{type:e}).then(function(a){t().thumbs.find(g=>g.user_id!==void 0).type=e,e==="up"?(t(t().thumbs_up_count+=1,!0),t(t().thumbs_down_count-=1,!0)):(t(t().thumbs_down_count+=1,!0),t(t().thumbs_up_count-=1,!0)),B()(t())}).catch(function(a){alert(a)}):axios.post("/api/messages/"+t().id+"/thumbs",{type:e}).then(function(a){t().thumbs.push({type:a.data.type,user_id:a.data.user_id,id:a.data.id}),t(e==="up"?t().thumbs_up_count+=1:t().thumbs_down_count+=1,!0),B()(t())}).catch(function(a){alert(a)})}function O(e){return Array.isArray(e.childs)?e.childs.some(a=>!a.is_deleted||O(a)):!1}It(()=>s(t()),()=>{x(m,t().thumbs.find(e=>e.user_id!==void 0)??null)}),It(()=>s(t()),()=>{x(w,t().thumbs_up_count-t().thumbs_down_count>4)}),It(()=>s(t()),()=>{x(j,t().thumbs_up_count-t().thumbs_down_count<-2)}),Vt(),Wt();var Z=Y(),c=z(Z);{var r=e=>{var a=Te();let g;var nt=n(a);{var T=y=>{var C=we(),V=n(C);E("click",V,At),i(y,C)},N=y=>{var C=Y(),V=z(C);{var lt=D=>{var P=ke();i(D,P)},ct=D=>{var P=De(),$=n(P),U=n($);let ft;var Dt=n(U);let vt;var ht=o(U,2),W=n(ht),F=o(ht,2);let gt;var Rt=n(F);let rt;var mt=o($,2),Lt=n(mt),jt=n(Lt);{var Xt=d=>{var _=Me();i(d,_)};p(jt,d=>{H()>0&&d(Xt)})}var Ht=o(jt,2),Zt=n(Ht);{var $t=d=>{var _=Ie();i(d,_)},te=d=>{var _=Y(),k=z(_);{var M=I=>{var A=Pt();J(()=>kt(A,(s(t()),u(()=>t().author.public_name||t().author.name)))),i(I,A)};p(k,I=>{s(t()),u(()=>t().author)&&I(M)},!0)}i(d,_)};p(Zt,d=>{s(t()),u(()=>t().is_anonymous)?d($t):d(te,!1)})}var Ot=o(Ht,4),Nt=n(Ot),ee=o(Nt);{var ae=d=>{var _=Ee();J(k=>Gt(_,"title",k),[()=>(s(Mt),s(ot),s(t()),u(()=>"Edited "+Mt(ot(t().updated_at),"dd.MM.yyyy HH:mm")))]),i(d,_)};p(ee,d=>{s(t()),u(()=>t().updated_at!==t().created_at)&&d(ae)})}var se=o(Lt,2),ne=n(se);{var ie=d=>{var _=Ae(),k=n(_);{var M=I=>{var A=Y(),G=z(A);ye(G,()=>(s(Yt),s(t()),u(()=>Yt.sanitize(t().text)))),i(I,A)};p(k,I=>{s(t()),u(()=>t().text)&&I(M)})}i(d,_)},re=d=>{var _=qe(),k=n(_),M=o(k,2);Bt(M,"input","message"),L(M,1,"trix-content form-control mb-2"),Tt(M,"min-height: 4rem;");var I=o(M,2),A=n(I),G=n(A),yt=o(A,2),xt=n(yt),wt=o(xt,2);J(()=>{Ut(k,(s(t()),u(()=>t().text))),be(G,(s(t()),u(()=>t().is_anonymous)))}),E("click",xt,X),E("click",wt,qt),i(d,_)};p(ne,d=>{f(at)?d(re,!1):d(ie)})}var oe=o(mt,2);{var de=d=>{var _=Ce(),k=n(_);let M;var I=o(k,2);{var A=G=>{var yt=Se(),xt=o(n(yt),2),wt=n(xt),ue=n(wt),le=o(wt,2),ce=n(le);E("click",ue,X),E("click",ce,v),i(G,yt)};p(I,G=>{S(),s(t()),u(()=>S().id===t().author_id)&&G(A)})}J(G=>M=L(k,1,"btn btn-link p-0 text-muted me-1",null,M,G),[()=>({disabled:f(K)})]),E("click",k,st),i(d,_)};p(oe,d=>{f(at)||d(de)})}J((d,_,k,M,I,A)=>{L(P,1,`d-flex gap-1 mb-2 message-content ${q(w)?"bg-light rounded-end-3 shadow-sm py-2 ps-1 pe-2 ms-1":"py-1 rounded-end-3"}`),ft=L(U,1,"btn btn-link p-0 text-muted text-decoration-none",null,ft,d),vt=L(Dt,1,"bi",null,vt,_),kt(W,(s(t()),u(()=>t().thumbs_up_count-t().thumbs_down_count))),gt=L(F,1,"btn btn-link p-0 text-muted text-decoration-none",null,gt,k),rt=L(Rt,1,"bi",null,rt,M),Gt(Ot,"title",I),kt(Nt,`${A??""} `)},[()=>({disabled:t().is_deleted}),()=>({"bi-hand-thumbs-up-fill":q(m)?.type==="up","bi-hand-thumbs-up":q(m)?.type!=="up"}),()=>({disabled:t().is_deleted}),()=>({"bi-hand-thumbs-down-fill":q(m)?.type==="down","bi-hand-thumbs-down":q(m)?.type!=="down"}),()=>(s(Mt),s(ot),s(t()),u(()=>Mt(ot(t().created_at),"dd.MM.yyyy HH:mm"))),()=>(s(zt),s(ot),s(t()),u(()=>zt(ot(t().created_at),new Date,{addSuffix:!0})))]),E("click",U,()=>l("up")),E("click",F,()=>l("down")),i(D,P)};p(V,D=>{s(t()),u(()=>t().is_deleted)?D(lt):D(ct,!1)},!0)}i(y,C)};p(nt,y=>{q(j)&&!f(dt)?y(T):y(N,!1)})}var it=o(nt,2);{var St=y=>{var C=Be(),V=n(C),lt=o(n(V),2);{var ct=W=>{var F=Re();i(W,F)},D=W=>{var F=Y(),gt=z(F);{var Rt=rt=>{var mt=Pt();J(()=>kt(mt,(s(t()),u(()=>t().author.public_name||t().author.name)))),i(rt,mt)};p(gt,rt=>{s(t()),u(()=>t().author)&&rt(Rt)},!0)}i(W,F)};p(lt,W=>{s(t()),u(()=>t().is_anonymous)?W(ct):W(D,!1)})}var P=o(V,2),$=o(n(P),2),U=o($,2);Bt(U,"input","replyMessage"),L(U,1,"trix-content form-control mb-2"),Tt(U,"min-height: 4rem;");var ft=o(U,2),Dt=o(n(ft),2),vt=n(Dt),ht=o(vt,2);J(()=>Ut($,(s(t()),u(()=>t().id)))),E("click",vt,st),E("click",ht,b),i(y,C)};p(it,y=>{f(K)&&y(St)})}var ut=o(it,2);{var Ct=y=>{var C=Y(),V=z(C);Jt(V,1,()=>(s(t()),u(()=>t().childs)),_e,(lt,ct)=>{var D=Y(),P=z(D);{let $=ve(()=>H()+1);Kt(P,{get message(){return q(ct)},get indent(){return q($)},get addMessage(){return bt()},get updateMessage(){return B()},get questionId(){return pt()}})}i(lt,D)}),i(y,C)};p(ut,y=>{s(t()),u(()=>t().childs)&&y(Ct)})}J(y=>g=L(a,1,"border-start border-2",null,g,y),[()=>({"ms-2":H()>0,"mb-3":!H()})]),i(e,a)};p(c,e=>{s(t()),u(()=>!t().is_deleted||O(t()))&&e(r)})}i(Et,Z),Ft(),et()}var Le=h('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading messages ...</span></div>'),je=h('<div class="text-muted">No comments yet. Be the first to leave a comment!</div>'),He=h('<div class="mb-3 d-flex justify-content-center"><!></div>'),Oe=h('<div class="mt-3 border-top border-2 pt-3"><input id="message" type="hidden" name="message" value=""/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous" checked/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Ne=h('<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-chat-square-text"></i> Add comment</button>'),Pe=h('<div class="mt-4 mb-3 px-2 py-2 border rounded-3 shadow-sm bg-white"><!> <!></div>');function Ke(Et,R){Qt(R,!1);let S=tt(R,"questionId",12),_t=tt(R,"questionContext",8);var et=Q(!1),m=[],w=Q([]),j=Q();const t={LOADING:"loading",EMPTY:"empty"};var H;function bt(){m=[],x(j,t.LOADING),H&&H.cancel();const b=S();H=ge(()=>{axios.get("/api/questions/"+S()+"/messages").then(function(v){if(b===S()){if(m=v.data,m.filter(l=>!l.is_deleted).length===0){x(w,[]),x(j,t.EMPTY);return}x(w,B(m))}}).catch(function(v){alert(v)})},1e3,{maxWait:2e3}),H()}function B(b){var v=structuredClone(b),l={},O=[];v.forEach(c=>{if(!c.parent_message_id&&!c.legacy_parent_message_id){O.push(c);return}var r=c.parent_message_id;if(!r){const e=v.find(a=>a.legacy_message_id===c.legacy_parent_message_id);e?r=e.id:console.error("Parent message not found for message",c)}l[r]||(l[r]=[]),l[r].push(c)}),Object.values(l).forEach(c=>{c.sort((r,e)=>e.thumbs_up_count-e.thumbs_down_count-(r.thumbs_up_count-r.thumbs_down_count))}),O.sort((c,r)=>r.thumbs_up_count-r.thumbs_down_count-(c.thumbs_up_count-c.thumbs_down_count));function Z(c){var r=c.id;l[r]&&(c.childs=l[r],c.childs.forEach(e=>{Z(e)}))}return O.forEach(c=>{Z(c)}),O}function pt(b){m.push(b),x(w,B(m))}function at(b){const v=m.findIndex(l=>l.id===b.id);m[v]=b,x(w,K(f(w),b))}function K(b,v){return b.map(l=>l.id===v.id?{...v,childs:l.childs}:l.childs?{...l,childs:K(l.childs,v)}:l)}function dt(){var b={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.post("/api/questions/"+S()+"/messages",b).then(function(v){X(),m.push(v.data),x(w,B(m))}).catch(function(v){alert(v)})}function X(){x(et,!f(et))}It(()=>s(S()),()=>{S(),x(w,[]),x(et,!1),bt()}),Vt(),Wt();var st=Y(),At=z(st);{var qt=b=>{var v=Pe(),l=n(v);Jt(l,1,()=>f(w),r=>r.id,(r,e,a)=>{Kt(r,{indent:0,addMessage:pt,updateMessage:at,get message(){return f(w)[a]},set message(g){f(w)[a]=g,me(()=>f(w))},get questionId(){return S()},set questionId(g){S(g)},$$legacy:!0})},r=>{var e=He(),a=n(e);{var g=T=>{var N=Le();i(T,N)},nt=T=>{var N=Y(),it=z(N);{var St=ut=>{var Ct=je();i(ut,Ct)};p(it,ut=>{f(j),u(()=>f(j)===t.EMPTY)&&ut(St)},!0)}i(T,N)};p(a,T=>{f(j),u(()=>f(j)===t.LOADING)?T(g):T(nt,!1)})}i(r,e)});var O=o(l,2);{var Z=r=>{var e=Oe(),a=n(e),g=o(a,2);Bt(g,"input","message"),L(g,1,"trix-content form-control mb-2"),Tt(g,"min-height: 4rem;");var nt=o(g,2),T=o(n(nt),2),N=n(T),it=o(N,2);E("click",N,X),E("click",it,dt),i(r,e)},c=r=>{var e=Ne();E("click",e,pe(X)),i(r,e)};p(O,r=>{f(et)?r(Z):r(c,!1)})}i(b,v)};p(At,b=>{s(_t()),u(()=>_t().isAnswered)&&b(qt)})}i(Et,st),Ft()}export{Ke as M};
