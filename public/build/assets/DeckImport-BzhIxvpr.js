import{d as me,p as pe,f as R,c as g,b as ve,j as v,g as t,s as h,a as r,k as ge,t as k,h as _,i as be,ap as V,o as W,n as z,v as he}from"./render-COO8opCt.js";import{i as E}from"./if-CwjDoZzt.js";import{a as G}from"./attributes-DYipTw7O.js";import{s as _e}from"./class-BfJg_ovI.js";import{s as we}from"./style-BtOSwUPa.js";import{b as ye}from"./this-DYJjSBKP.js";import{i as xe,s as qe}from"./sql-wasm-1MhpQ5y_.js";import{l as ke}from"./lodash-d8dSvcKh.js";import"./_commonjsHelpers-CE1G-McA.js";var Ee=R('<div class="alert alert-light text-truncate"><strong>Selected:</strong> </div>'),Re=R('<div class="mt-2"><a class="btn btn-sm btn-primary">View imported deck</a></div>'),Ie=R("<div> <!></div>"),Ce=R('<span class="spinner-border spinner-border-sm me-2"></span> Importing...',1),Se=R('<div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar"><!></div></div>'),De=R('<button class="btn btn-sm btn-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#importOffcanvas"><i class="bi bi-upload"></i> Import deck</button> <div class="offcanvas offcanvas-end" tabindex="-1" id="importOffcanvas" aria-labelledby="importOffcanvasLabel"><div class="offcanvas-header"><h5 class="offcanvas-title" id="importOffcanvasLabel">Import deck</h5> <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div> <div class="offcanvas-body"><div class="mb-3"><label for="importFile" class="form-label">Select a file to import</label> <input class="form-control" type="file" id="importFile" accept=".json,.sqlite"/> <div class="form-text">Supported formats: omcarchive.json or omcarchive.sqlite</div></div> <!> <!> <div class="d-grid"><button class="btn btn-primary mb-3"><!></button> <!></div></div></div>',1);function Fe(K,X){pe(X,!0);let P,m=h(null),b=h(null),p=h(null),I=h(!1),T=h(0),Q=h(0),C=ge(()=>ke.round(t(T)/t(Q)*100)),B=h(""),$=h(null);async function Y(){return P||(P=await xe({locateFile:()=>qe})),P}async function j(e,i=4,d=5e3,a=2,l=[429,500,502,503,504]){let s=d;for(let n=0;n<=i;n++)try{return await e()}catch(o){if(!o.response||!l.includes(o.response.status)||n===i)throw o;let f=s;o.response.headers["retry-after"]&&(f=parseInt(o.response.headers["retry-after"])*1e3),console.log(`Request failed with status ${o.response.status}. Retrying in ${f}ms...`),await new Promise(x=>setTimeout(x,f)),s=s*a}}function Z(e){r(m,e.target.files[0],!0),t(m)&&(r(B,t(m).name,!0),t(m).name.endsWith(".json")?r(b,"json"):t(m).name.endsWith(".sqlite")?r(b,"sqlite"):(r(b,null),r(p,{type:"error",message:"Unsupported file format"},!0)))}async function ee(){if(!t(m)||!t(b)){r(p,{type:"error",message:"Please select a valid file"},!0);return}r(I,!0),r(T,0),r(Q,0),r(p,null);try{let e;t(b)==="json"?e=await se(t(m)):e=await te(t(m)),r(Q,e.cases.length+e.questions.length);const i={name:e.name,description:e.description,exam_at:e.exam_at||null,access:"private"},a=(await j(()=>axios.post("/api/decks",i))).data,l=[];if(e.cases&&e.cases.length>0)for(const s of e.cases){const n={name:s.name,text:s.text,deck_id:a.id},f=(await j(()=>axios.post("/api/cases",n))).data;V(T),f.export_id=s.id,l.push(f)}if(e.questions&&e.questions.length>0)for(const s of e.questions){let n=null;if(s.case_id&&l.length>0){const u=l.find(c=>c.export_id===s.case_id);u&&(n=u.id)}const o=s.answers?.map(u=>({text:u.text,hint:u.hint||null,is_correct:u.id===s.correct_answer_id}))||[],f={text:s.text,hint:s.hint||null,comment:s.comment||null,type:s.type,is_invalid:s.is_invalid,needs_review:s.needs_review,case_id:n||null,answers:o},w=(await j(()=>axios.post(`/api/decks/${a.id}/questions`,f))).data;if(s.images&&s.images.length>0)for(const u of s.images){const c=new FormData;c.append("image",u.blob),await j(()=>axios.post(`/api/questions/${w.id}/images`,c,{headers:{"Content-Type":"multipart/form-data"}}))}V(T)}r(p,{type:"success",message:`Deck "${a.name.length>25?a.name.slice(0,25)+"...":a.name}" imported successfully!`,deckId:a.id},!0),r(m,null),r(b,null),t($)&&(t($).value="")}catch(e){r(p,{type:"error",message:e.response?.data?.message||e.message||"Import failed"},!0)}finally{r(I,!1)}}async function se(e){return new Promise((i,d)=>{const a=new FileReader;a.onload=async l=>{try{const s=JSON.parse(l.target.result);if(s.questions&&s.questions.length>0){for(const n of s.questions)if(n.images&&n.images.length>0){for(const o of n.images)if(o.base64){const f=await fetch(o.base64);o.blob=await f.blob(),delete o.base64}}}i(s)}catch{d(new Error("Invalid JSON file"))}},a.onerror=()=>d(new Error("Failed to read file")),a.readAsText(e)})}async function te(e){const i=await Y(),d=await e.arrayBuffer(),a=new i.Database(new Uint8Array(d)),l=a.exec("SELECT * FROM decks LIMIT 1");if(!l[0]||!l[0].values.length)throw new Error("No deck found in SQLite file");const s=l[0].columns,n=l[0].values[0],o={};s.forEach((w,u)=>o[w]=n[u]);const f=a.exec("SELECT * FROM cases");if(o.cases=[],f[0]){const w=f[0].columns;for(const u of f[0].values){const c={};w.forEach((S,D)=>c[S]=u[D]),o.cases.push(c)}}const x=a.exec("SELECT * FROM questions WHERE deck_id = ?",[o.id]);if(o.questions=[],x[0]){const w=x[0].columns;for(const u of x[0].values){const c={};w.forEach((y,F)=>c[y]=u[F]);const S=a.exec("SELECT * FROM images WHERE question_id = ?",[c.id]);if(c.images=[],S[0]){const y=S[0].columns,F=y.indexOf("blob");for(const O of S[0].values){const L={};for(const q of y)q==="blob"?L[q]=new Blob([O[F]],{type:"image/jpeg"}):L[q]=O[y.indexOf(q)];c.images.push(L)}}const D=a.exec("SELECT * FROM answers WHERE question_id = ?",[c.id]);if(c.answers=[],D[0]){const y=D[0].columns;for(const F of D[0].values){const O={};y.forEach((L,q)=>O[L]=F[q]),c.answers.push(O)}}o.questions.push(c)}}return a.close(),o}var J=De(),ae=g(ve(J),2),oe=g(v(ae),2),N=v(oe),U=g(v(N),2);U.__change=Z,ye(U,e=>r($,e),()=>t($));var A=g(N,2);{var ie=e=>{var i=Ee(),d=g(v(i));k(a=>W(d,` ${t(B)??""} (${a??""})`),[()=>t(b)?.toUpperCase()]),_(e,i)};E(A,e=>{t(m)&&e(ie)})}var H=g(A,2);{var ne=e=>{var i=Ie(),d=v(i),a=g(d);{var l=s=>{var n=Re(),o=v(n);k(()=>G(o,"href",`/decks/${t(p).deckId??""}`)),_(s,n)};E(a,s=>{t(p).type==="success"&&t(p).deckId&&s(l)})}k(()=>{_e(i,1,`alert alert-${t(p).type==="success"?"success":"danger"}`),W(d,`${t(p).message??""} `)}),_(e,i)};E(H,e=>{t(p)&&e(ne)})}var re=g(H,2),M=v(re);M.__click=ee;var le=v(M);{var ce=e=>{var i=Ce();_(e,i)},de=e=>{var i=z("Import deck");_(e,i)};E(le,e=>{t(I)?e(ce):e(de,!1)})}var fe=g(M,2);{var ue=e=>{var i=Se(),d=v(i),a=v(d);{var l=s=>{var n=z();k(()=>W(n,`${t(C)??""}%`)),_(s,n)};E(a,s=>{t(C)>20&&s(l)})}k(()=>{G(i,"aria-valuenow",t(C)),we(d,`width: ${t(C)??""}%`)}),_(e,i)};E(fe,e=>{t(I)&&t(C)&&e(ue)})}k(()=>M.disabled=!t(m)||!t(b)||t(I)),_(K,J),be()}me(["change","click"]);const Oe=document.getElementById("DeckImport");he(Fe,{target:Oe});
