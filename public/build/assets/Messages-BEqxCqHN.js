import{d as jt,p as Ot,j,b as O,e as n,h as Ht,f,g,u as dt,q as u,s as Q,i as s,c as i,t as P,a as y,l as pt,k as Bt,m as kt}from"./render-DmmYWkZq.js";import{i as b}from"./if-qgMZekRM.js";import{e as Nt,i as se,p as ne}from"./event-modifiers-B-z6qf1-.js";import{s as It,d as Ct,a as Lt,b as ie}from"./attributes-Cp2PrCir.js";import{s as R}from"./class-BfJg_ovI.js";import{s as Et}from"./style-BtOSwUPa.js";import{p as Gt,a as re,s as oe}from"./props-Bo30g3de.js";import{r as de}from"./legacy-client-oIJ-7bi0.js";import{p as ue,d as le}from"./purify.es-CmVf96vk.js";import{h as ce}from"./html-ChNwDKpL.js";import{U as ve}from"./UserSettingsStore-Ck4-ns3C.js";import{f as Tt,p as Mt}from"./parseISO-BGu1X6cY.js";import{f as me}from"./formatDistance-C5pjvq49.js";var _e=f('<div class="p-2"><button class="btn btn-link btn-sm text-muted p-0"><i class="bi bi-eye-slash me-1"></i>Comment hidden due to low rating. Click to show.</button></div>'),be=f('<div class="p-2"><span class="text-muted small"><i class="bi bi-trash me-1"></i>This comment has been deleted.</span></div>'),fe=f('<i class="bi bi-arrow-return-right" title="Answer"></i> <span>•</span>',1),pe=f('<i class="bi bi-incognito" title="Anonymous"></i>'),he=f('<i class="bi bi-pencil ms-1"></i>'),ge=f('<div class="trix-content pe-4"><!></div>'),ye=f('<div class="pe-2"><input id="message" type="hidden" name="message"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous"/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),xe=f('<div class="dropdown"><button class="btn btn-link p-0 text-muted me-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button> <ul class="dropdown-menu dropdown-menu-end"><li><button class="dropdown-item"><i class="bi bi-pencil me-2"></i>Edit</button></li> <li><button class="dropdown-item"><i class="bi bi-trash me-2"></i>Delete</button></li></ul></div>'),we=f('<div class="d-flex align-items-end gap-2 pe-1"><button title="Reply"><i class="bi bi-reply"></i></button> <!></div>'),ke=f('<div><div class="d-flex flex-column gap-1" style="min-width: 2rem"><button><i></i></button> <span class="text-center text-muted small"> </span> <button><i></i></button></div> <div class="flex-grow-1"><div class="d-flex gap-2 text-muted small"><!> <span><!></span> <span>•</span> <span> <!></span></div> <div class="mt-1"><!></div></div> <!></div>'),Me=f('<i class="bi bi-incognito" title="Anonymous"></i>'),Ie=f('<div class="border-start border-2 my-2 ms-2 ps-2"><div class="d-flex gap-2 text-muted small mb-2"><i class="bi bi-arrow-return-right" title="Answer"></i> Replying to <!></div> <div><input id="replyMessage" type="hidden" name="replyMessage"/> <input id="parentMessageId" type="hidden" name="parentMessageId"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between"><div class="form-check"><input type="checkbox" class="form-check-input" id="replyAnonymous" checked/> <label class="form-check-label small" for="replyAnonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Reply</button></div></div></div></div>',2),Ee=f("<div><!> <!> <!></div>");function Pt(ht,c){Ot(c,!0);const U=()=>oe(ve,"$UserSettings",B),[B,V]=re();let t=Gt(c,"message",15),_=dt(()=>t().thumbs.find(a=>a.user_id!==void 0)??null),W=dt(()=>t().thumbs_up_count-t().thumbs_down_count>4),F=dt(()=>t().thumbs_up_count-t().thumbs_down_count<-2);var J=Q(!1),H=Q(!1),tt=Q(!1);function et(){y(J,!u(J))}function K(){y(H,!u(H))}function gt(){y(tt,!u(tt))}function at(){var a={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.put("/api/messages/"+t().id,a).then(function(e){et(),t(t().text=e.data.text,!0),t(t().is_anonymous=e.data.is_anonymous,!0),t(t().updated_at=e.data.updated_at,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function ut(){var a={text:document.getElementById("replyMessage").value,parent_message_id:document.getElementById("parentMessageId").value,is_anonymous:document.getElementById("replyAnonymous").checked};axios.post("/api/questions/"+c.questionId+"/messages",a).then(function(e){K(),c.addMessage(e.data)}).catch(function(e){alert(e)})}function yt(){confirm("Are you sure you want to delete this message?")&&axios.delete("/api/messages/"+t().id).then(function(a){t(t().text="",!0),t(t().is_deleted=!0,!0),c.updateMessage(t())}).catch(function(a){alert(a)})}function lt(a){g(_)!==null?g(_).type===a?axios.delete("/api/messages/"+t().id+"/thumbs/"+g(_).id).then(function(e){t(t().thumbs=t().thumbs.filter(r=>r.user_id===void 0),!0),t(a==="up"?t().thumbs_up_count-=1:t().thumbs_down_count-=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.put("/api/messages/"+t().id+"/thumbs/"+g(_).id,{type:a}).then(function(e){t().thumbs.find(r=>r.user_id!==void 0).type=a,a==="up"?(t(t().thumbs_up_count+=1,!0),t(t().thumbs_down_count-=1,!0)):(t(t().thumbs_down_count+=1,!0),t(t().thumbs_up_count-=1,!0)),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.post("/api/messages/"+t().id+"/thumbs",{type:a}).then(function(e){t().thumbs.push({type:e.data.type,user_id:e.data.user_id,id:e.data.id}),t(a==="up"?t().thumbs_up_count+=1:t().thumbs_down_count+=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function l(a){return Array.isArray(a.childs)?a.childs.some(e=>!e.is_deleted||l(e)):!1}var d=j(),v=O(d);{var X=a=>{var e=Ee();let r;var x=s(e);{var A=p=>{var h=_e(),D=s(h);D.__click=gt,n(p,h)},w=p=>{var h=j(),D=O(h);{var nt=M=>{var L=be();n(M,L)},it=M=>{var L=ke(),Y=s(L),T=s(Y);let ct;T.__click=()=>lt("up");var xt=s(T);let rt;var vt=i(T,2),N=s(vt),G=i(vt,2);let mt;G.__click=()=>lt("down");var wt=s(G);let $;var ot=i(Y,2),At=s(ot),qt=s(At);{var Ut=o=>{var m=fe();n(o,m)};b(qt,o=>{c.indent>0&&o(Ut)})}var Dt=i(qt,2),Yt=s(Dt);{var zt=o=>{var m=pe();n(o,m)},Qt=o=>{var m=j(),k=O(m);{var I=E=>{var S=Bt();P(()=>pt(S,t().author.public_name||t().author.name)),n(E,S)};b(k,E=>{t().author&&E(I)},!0)}n(o,m)};b(Yt,o=>{t().is_anonymous?o(zt):o(Qt,!1)})}var St=i(Dt,4),Rt=s(St),Vt=i(Rt);{var Wt=o=>{var m=he();P(k=>Lt(m,"title",k),[()=>"Edited "+Tt(Mt(t().updated_at),"dd.MM.yyyy HH:mm")]),n(o,m)};b(Vt,o=>{t().updated_at!==t().created_at&&o(Wt)})}var Ft=i(At,2),Jt=s(Ft);{var Kt=o=>{var m=ge(),k=s(m);{var I=E=>{var S=j(),z=O(S);ce(z,()=>ue.sanitize(t().text)),n(E,S)};b(k,E=>{t().text&&E(I)})}n(o,m)},Xt=o=>{var m=ye(),k=s(m),I=i(k,2);It(I,"input","message"),R(I,1,"trix-content form-control mb-2"),Et(I,"min-height: 4rem;");var E=i(I,2),S=s(E),z=s(S),_t=i(S,2),bt=s(_t);bt.__click=et;var ft=i(bt,2);ft.__click=at,P(()=>{Ct(k,t().text),ie(z,t().is_anonymous)}),n(o,m)};b(Jt,o=>{u(J)?o(Xt,!1):o(Kt)})}var Zt=i(ot,2);{var $t=o=>{var m=we(),k=s(m);let I;k.__click=K;var E=i(k,2);{var S=z=>{var _t=xe(),bt=i(s(_t),2),ft=s(bt),te=s(ft);te.__click=et;var ee=i(ft,2),ae=s(ee);ae.__click=yt,n(z,_t)};b(E,z=>{U().id===t().author_id&&z(S)})}P(()=>I=R(k,1,"btn btn-link p-0 text-muted me-1",null,I,{disabled:u(H)})),n(o,m)};b(Zt,o=>{u(J)||o($t)})}P((o,m)=>{R(L,1,`d-flex gap-1 mb-2 message-content ${g(W)?"bg-light rounded-end-3 shadow-sm py-2 ps-1 pe-2 ms-1":"py-1 rounded-end-3"}`),ct=R(T,1,"btn btn-link p-0 text-muted text-decoration-none",null,ct,{disabled:t().is_deleted}),rt=R(xt,1,"bi",null,rt,{"bi-hand-thumbs-up-fill":g(_)?.type==="up","bi-hand-thumbs-up":g(_)?.type!=="up"}),pt(N,t().thumbs_up_count-t().thumbs_down_count),mt=R(G,1,"btn btn-link p-0 text-muted text-decoration-none",null,mt,{disabled:t().is_deleted}),$=R(wt,1,"bi",null,$,{"bi-hand-thumbs-down-fill":g(_)?.type==="down","bi-hand-thumbs-down":g(_)?.type!=="down"}),Lt(St,"title",o),pt(Rt,`${m??""} `)},[()=>Tt(Mt(t().created_at),"dd.MM.yyyy HH:mm"),()=>me(Mt(t().created_at),new Date,{addSuffix:!0})]),n(M,L)};b(D,M=>{t().is_deleted?M(nt):M(it,!1)},!0)}n(p,h)};b(x,p=>{g(F)&&!u(tt)?p(A):p(w,!1)})}var Z=i(x,2);{var q=p=>{var h=Ie(),D=s(h),nt=i(s(D),2);{var it=N=>{var G=Me();n(N,G)},M=N=>{var G=j(),mt=O(G);{var wt=$=>{var ot=Bt();P(()=>pt(ot,t().author.public_name||t().author.name)),n($,ot)};b(mt,$=>{t().author&&$(wt)},!0)}n(N,G)};b(nt,N=>{t().is_anonymous?N(it):N(M,!1)})}var L=i(D,2),Y=i(s(L),2),T=i(Y,2);It(T,"input","replyMessage"),R(T,1,"trix-content form-control mb-2"),Et(T,"min-height: 4rem;");var ct=i(T,2),xt=i(s(ct),2),rt=s(xt);rt.__click=K;var vt=i(rt,2);vt.__click=ut,P(()=>Ct(Y,t().id)),n(p,h)};b(Z,p=>{u(H)&&p(q)})}var C=i(Z,2);{var st=p=>{var h=j(),D=O(h);Nt(D,17,()=>t().childs,se,(nt,it)=>{var M=j(),L=O(M);{let Y=dt(()=>c.indent+1);Pt(L,{get message(){return g(it)},get indent(){return g(Y)},get addMessage(){return c.addMessage},get updateMessage(){return c.updateMessage},get questionId(){return c.questionId}})}n(nt,M)}),n(p,h)};b(C,p=>{t().childs&&p(st)})}P(()=>r=R(e,1,"border-start border-2",null,r,{"ms-2":c.indent>0,"mb-3":!c.indent})),n(a,e)};b(v,a=>{(!t().is_deleted||l(t()))&&a(X)})}n(ht,d),Ht(),V()}jt(["click"]);var Ae=f('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading messages ...</span></div>'),qe=f('<div class="text-muted">No comments yet. Be the first to leave a comment!</div>'),De=f('<div class="mb-3 d-flex justify-content-center"><!></div>'),Se=f('<div class="mt-3 border-top border-2 pt-3"><input id="message" type="hidden" name="message" value=""/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous" checked/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Re=f('<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-chat-square-text"></i> Add comment</button>'),Be=f('<div class="mt-4 mb-3 px-2 py-2 border rounded-3 shadow-sm bg-white"><!> <!></div>');function Ve(ht,c){Ot(c,!0);const U={LOADING:"loading",EMPTY:"empty"};let B=Gt(c,"questionId",15);var V=Q(!1),t=Q(kt([])),_=Q(kt([])),W=Q(kt(U.LOADING));de(()=>{B(),y(_,[],!0),y(V,!1),J()});var F;function J(){y(t,[],!0),y(W,U.LOADING,!0),F&&F.cancel();const l=B();F=le(()=>{axios.get("/api/questions/"+B()+"/messages").then(function(d){if(l===B()){if(y(t,d.data,!0),u(t).filter(v=>!v.is_deleted).length===0){y(_,[],!0),y(W,U.EMPTY,!0);return}y(_,H(u(t)),!0)}}).catch(function(d){alert(d)})},1e3,{maxWait:2e3}),F()}function H(l){var d={},v=[];l.forEach(a=>{if(!a.parent_message_id&&!a.legacy_parent_message_id){v.push(a);return}var e=a.parent_message_id;if(!e){const r=l.find(x=>x.legacy_message_id===a.legacy_parent_message_id);r?e=r.id:console.error("Parent message not found for message",a)}d[e]||(d[e]=[]),d[e].push(a)}),Object.values(d).forEach(a=>{a.sort((e,r)=>r.thumbs_up_count-r.thumbs_down_count-(e.thumbs_up_count-e.thumbs_down_count))}),v.sort((a,e)=>e.thumbs_up_count-e.thumbs_down_count-(a.thumbs_up_count-a.thumbs_down_count));function X(a){var e=a.id;d[e]&&(a.childs=d[e],a.childs.forEach(r=>{X(r)}))}return v.forEach(a=>{X(a)}),v}function tt(l){u(t).push(l),y(_,H(u(t)),!0)}function et(l){const d=u(t).findIndex(v=>v.id===l.id);u(t)[d]=l,y(_,K(u(_),l),!0)}function K(l,d){return l.map(v=>v.id===d.id?{...d,childs:v.childs}:v.childs?{...v,childs:K(v.childs,d)}:v)}function gt(){var l={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.post("/api/questions/"+B()+"/messages",l).then(function(d){at(),u(t).push(d.data),y(_,H(u(t)),!0)}).catch(function(d){alert(d)})}function at(){y(V,!u(V))}var ut=j(),yt=O(ut);{var lt=l=>{var d=Be(),v=s(d);Nt(v,19,()=>u(_),r=>r.id,(r,x,A)=>{Pt(r,{indent:0,addMessage:tt,updateMessage:et,get message(){return u(_)[g(A)]},set message(w){u(_)[g(A)]=w},get questionId(){return B()},set questionId(w){B(w)}})},r=>{var x=De(),A=s(x);{var w=q=>{var C=Ae();n(q,C)},Z=q=>{var C=j(),st=O(C);{var p=h=>{var D=qe();n(h,D)};b(st,h=>{u(W)===U.EMPTY&&h(p)},!0)}n(q,C)};b(A,q=>{u(W)===U.LOADING?q(w):q(Z,!1)})}n(r,x)});var X=i(v,2);{var a=r=>{var x=Se(),A=s(x),w=i(A,2);It(w,"input","message"),R(w,1,"trix-content form-control mb-2"),Et(w,"min-height: 4rem;");var Z=i(w,2),q=i(s(Z),2),C=s(q);C.__click=at;var st=i(C,2);st.__click=gt,n(r,x)},e=r=>{var x=Re(),A=dt(()=>ne(at));x.__click=function(...w){g(A)?.apply(this,w)},n(r,x)};b(X,r=>{u(V)?r(a):r(e,!1)})}n(l,d)};b(yt,l=>{c.questionContext.isAnswered&&l(lt)})}n(ht,ut),Ht()}jt(["click"]);export{Ve as M};
