import{d as Ot,p as Ht,j as N,b as G,e as i,h as Nt,f,g,u as ut,q as d,s as V,i as s,c as n,t as H,a as y,l as ht,k as Ct,m as Mt}from"./render-wDF33Nt9.js";import{i as b}from"./if-bo9VvZzx.js";import{e as Gt,i as ne,p as ie}from"./event-modifiers-C_oJkXcz.js";import{s as Et,d as Lt,a as Tt,b as re}from"./attributes-B-utWOYn.js";import{s as R}from"./class-BfJg_ovI.js";import{s as At}from"./style-BtOSwUPa.js";import{p as Pt,s as oe,a as de}from"./props-BKJLc1dz.js";import{r as ue}from"./legacy-client-BEOB7oQD.js";import{h as $,p as le,d as ce}from"./hotkeys.esm-BpJec7O2.js";import{h as ve}from"./html-D-buyqeJ.js";import{U as me}from"./UserSettingsStore-CJf4IpeL.js";import{f as jt,p as It}from"./parseISO-BGu1X6cY.js";import{f as _e}from"./formatDistance-C5pjvq49.js";var be=f('<div class="p-2"><button class="btn btn-link btn-sm text-muted p-0"><i class="bi bi-eye-slash me-1"></i>Comment hidden due to low rating. Click to show.</button></div>'),fe=f('<div class="p-2"><span class="text-muted small"><i class="bi bi-trash me-1"></i>This comment has been deleted.</span></div>'),pe=f('<i class="bi bi-arrow-return-right" title="Answer"></i> <span>•</span>',1),he=f('<i class="bi bi-incognito" title="Anonymous"></i>'),ge=f('<i class="bi bi-pencil ms-1"></i>'),ye=f('<div class="trix-content pe-4"><!></div>'),xe=f('<div class="pe-2"><input id="message" type="hidden" name="message"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous"/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),we=f('<div class="dropdown"><button class="btn btn-link p-0 text-muted me-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button> <ul class="dropdown-menu dropdown-menu-end"><li><button class="dropdown-item btn btn-sm"><i class="bi bi-pencil me-2"></i>Edit</button></li> <li><button class="dropdown-item btn btn-sm"><i class="bi bi-trash me-2"></i>Delete</button></li></ul></div>'),ke=f('<div class="d-flex align-items-end gap-2 pe-1"><button title="Reply"><i class="bi bi-reply"></i></button> <!></div>'),Me=f('<div><div class="d-flex flex-column gap-1" style="min-width: 2rem"><button><i></i></button> <span class="text-center text-muted small"> </span> <button><i></i></button></div> <div class="flex-grow-1"><div class="d-flex gap-2 text-muted small"><!> <span><!></span> <span>•</span> <span> <!></span></div> <div class="mt-1"><!></div></div> <!></div>'),Ie=f('<i class="bi bi-incognito" title="Anonymous"></i>'),Ee=f('<div class="border-start border-2 my-2 ms-2 ps-2"><div class="d-flex gap-2 text-muted small mb-2"><i class="bi bi-arrow-return-right" title="Answer"></i> Replying to <!></div> <div><input id="replyMessage" type="hidden" name="replyMessage"/> <input id="parentMessageId" type="hidden" name="parentMessageId"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between"><div class="form-check"><input type="checkbox" class="form-check-input" id="replyAnonymous" checked/> <label class="form-check-label small" for="replyAnonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Reply</button></div></div></div></div>',2),Ae=f("<div><!> <!> <!></div>");function Ut(gt,c){Ht(c,!0);const P=()=>de(me,"$UserSettings",B),[B,U]=oe();let t=Pt(c,"message",15),_=ut(()=>t().thumbs.find(a=>a.user_id!==void 0)??null),W=ut(()=>t().thumbs_up_count-t().thumbs_down_count>4),F=ut(()=>t().thumbs_up_count-t().thumbs_down_count<-2);var Y=V(!1),C=V(!1),tt=V(!1);function et(){y(Y,!d(Y)),d(Y)?$.setScope("editor"):$.setScope("questions")}function J(){y(C,!d(C)),d(C)?$.setScope("editor"):$.setScope("questions")}function yt(){y(tt,!d(tt))}function at(){var a={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.put("/api/messages/"+t().id,a).then(function(e){et(),t(t().text=e.data.text,!0),t(t().is_anonymous=e.data.is_anonymous,!0),t(t().updated_at=e.data.updated_at,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function lt(){var a={text:document.getElementById("replyMessage").value,parent_message_id:document.getElementById("parentMessageId").value,is_anonymous:document.getElementById("replyAnonymous").checked};axios.post("/api/questions/"+c.questionId+"/messages",a).then(function(e){J(),c.addMessage(e.data)}).catch(function(e){alert(e)})}function xt(){confirm("Are you sure you want to delete this message?")&&axios.delete("/api/messages/"+t().id).then(function(a){t(t().text="",!0),t(t().is_deleted=!0,!0),c.updateMessage(t())}).catch(function(a){alert(a)})}function ct(a){g(_)!==null?g(_).type===a?axios.delete("/api/messages/"+t().id+"/thumbs/"+g(_).id).then(function(e){t(t().thumbs=t().thumbs.filter(r=>r.user_id===void 0),!0),t(a==="up"?t().thumbs_up_count-=1:t().thumbs_down_count-=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.put("/api/messages/"+t().id+"/thumbs/"+g(_).id,{type:a}).then(function(e){t().thumbs.find(r=>r.user_id!==void 0).type=a,a==="up"?(t(t().thumbs_up_count+=1,!0),t(t().thumbs_down_count-=1,!0)):(t(t().thumbs_down_count+=1,!0),t(t().thumbs_up_count-=1,!0)),c.updateMessage(t())}).catch(function(e){alert(e)}):axios.post("/api/messages/"+t().id+"/thumbs",{type:a}).then(function(e){t().thumbs.push({type:e.data.type,user_id:e.data.user_id,id:e.data.id}),t(a==="up"?t().thumbs_up_count+=1:t().thumbs_down_count+=1,!0),c.updateMessage(t())}).catch(function(e){alert(e)})}function l(a){return Array.isArray(a.childs)?a.childs.some(e=>!e.is_deleted||l(e)):!1}var u=N(),v=G(u);{var K=a=>{var e=Ae();let r;var x=s(e);{var E=p=>{var h=be(),q=s(h);q.__click=yt,i(p,h)},w=p=>{var h=N(),q=G(h);{var nt=S=>{var z=fe();i(S,z)},it=S=>{var z=Me(),rt=s(z),T=s(rt);let vt;T.__click=()=>ct("up");var wt=s(T);let ot;var mt=n(T,2),j=s(mt),O=n(mt,2);let _t;O.__click=()=>ct("down");var kt=s(O);let Z;var dt=n(rt,2),qt=s(dt),St=s(qt);{var Yt=o=>{var m=pe();i(o,m)};b(St,o=>{c.indent>0&&o(Yt)})}var Dt=n(St,2),zt=s(Dt);{var Qt=o=>{var m=he();i(o,m)},Vt=o=>{var m=N(),k=G(m);{var M=I=>{var D=Ct();H(()=>ht(D,t().author.public_name||t().author.name)),i(I,D)};b(k,I=>{t().author&&I(M)},!0)}i(o,m)};b(zt,o=>{t().is_anonymous?o(Qt):o(Vt,!1)})}var Rt=n(Dt,4),Bt=s(Rt),Wt=n(Bt);{var Ft=o=>{var m=ge();H(k=>Tt(m,"title",k),[()=>"Edited "+jt(It(t().updated_at),"dd.MM.yyyy HH:mm")]),i(o,m)};b(Wt,o=>{t().updated_at!==t().created_at&&o(Ft)})}var Jt=n(qt,2),Kt=s(Jt);{var Xt=o=>{var m=ye(),k=s(m);{var M=I=>{var D=N(),Q=G(D);ve(Q,()=>le.sanitize(t().text)),i(I,D)};b(k,I=>{t().text&&I(M)})}i(o,m)},Zt=o=>{var m=xe(),k=s(m),M=n(k,2);Et(M,"input","message"),R(M,1,"trix-content form-control mb-2"),At(M,"min-height: 4rem;");var I=n(M,2),D=s(I),Q=s(D),bt=n(D,2),ft=s(bt);ft.__click=et;var pt=n(ft,2);pt.__click=at,H(()=>{Lt(k,t().text),re(Q,t().is_anonymous)}),i(o,m)};b(Kt,o=>{d(Y)?o(Zt,!1):o(Xt)})}var $t=n(dt,2);{var te=o=>{var m=ke(),k=s(m);let M;k.__click=J;var I=n(k,2);{var D=Q=>{var bt=we(),ft=n(s(bt),2),pt=s(ft),ee=s(pt);ee.__click=et;var ae=n(pt,2),se=s(ae);se.__click=xt,i(Q,bt)};b(I,Q=>{P().id===t().author_id&&Q(D)})}H(()=>M=R(k,1,"btn btn-link p-0 text-muted me-1",null,M,{disabled:d(C)})),i(o,m)};b($t,o=>{d(Y)||o(te)})}H((o,m)=>{R(z,1,`d-flex gap-1 mb-2 message-content ${g(W)?"bg-light rounded-end-3 shadow-sm py-2 ps-1 pe-2 ms-1":"py-1 rounded-end-3"}`),vt=R(T,1,"btn btn-link p-0 text-muted text-decoration-none",null,vt,{disabled:t().is_deleted}),ot=R(wt,1,"bi",null,ot,{"bi-hand-thumbs-up-fill":g(_)?.type==="up","bi-hand-thumbs-up":g(_)?.type!=="up"}),ht(j,t().thumbs_up_count-t().thumbs_down_count),_t=R(O,1,"btn btn-link p-0 text-muted text-decoration-none",null,_t,{disabled:t().is_deleted}),Z=R(kt,1,"bi",null,Z,{"bi-hand-thumbs-down-fill":g(_)?.type==="down","bi-hand-thumbs-down":g(_)?.type!=="down"}),Tt(Rt,"title",o),ht(Bt,`${m??""} `)},[()=>jt(It(t().created_at),"dd.MM.yyyy HH:mm"),()=>_e(It(t().created_at),new Date,{addSuffix:!0})]),i(S,z)};b(q,S=>{t().is_deleted?S(nt):S(it,!1)},!0)}i(p,h)};b(x,p=>{g(F)&&!d(tt)?p(E):p(w,!1)})}var X=n(x,2);{var A=p=>{var h=Ee(),q=s(h),nt=n(s(q),2);{var it=j=>{var O=Ie();i(j,O)},S=j=>{var O=N(),_t=G(O);{var kt=Z=>{var dt=Ct();H(()=>ht(dt,t().author.public_name||t().author.name)),i(Z,dt)};b(_t,Z=>{t().author&&Z(kt)},!0)}i(j,O)};b(nt,j=>{t().is_anonymous?j(it):j(S,!1)})}var z=n(q,2),rt=n(s(z),2),T=n(rt,2);Et(T,"input","replyMessage"),R(T,1,"trix-content form-control mb-2"),At(T,"min-height: 4rem;");var vt=n(T,2),wt=n(s(vt),2),ot=s(wt);ot.__click=J;var mt=n(ot,2);mt.__click=lt,H(()=>Lt(rt,t().id)),i(p,h)};b(X,p=>{d(C)&&p(A)})}var L=n(X,2);{var st=p=>{var h=N(),q=G(h);Gt(q,17,()=>t().childs,ne,(nt,it)=>{{let S=ut(()=>c.indent+1);Ut(nt,{get message(){return g(it)},get indent(){return g(S)},get addMessage(){return c.addMessage},get updateMessage(){return c.updateMessage},get questionId(){return c.questionId}})}}),i(p,h)};b(L,p=>{t().childs&&p(st)})}H(()=>r=R(e,1,"border-start border-2",null,r,{"ms-2":c.indent>0,"mb-3":!c.indent})),i(a,e)};b(v,a=>{(!t().is_deleted||l(t()))&&a(K)})}i(gt,u),Nt(),U()}Ot(["click"]);var qe=f('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading messages ...</span></div>'),Se=f('<div class="text-muted">No comments yet. Be the first to leave a comment!</div>'),De=f('<div class="mb-3 d-flex justify-content-center"><!></div>'),Re=f('<div class="mt-3 border-top border-2 pt-3"><input id="message" type="hidden" name="message" value=""/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous" checked/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Be=f('<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-chat-square-text"></i> Add comment</button>'),Ce=f('<div class="mt-4 mb-3 px-2 py-2 border rounded-3 shadow-sm bg-white"><!> <!></div>');function We(gt,c){Ht(c,!0);const P={LOADING:"loading",EMPTY:"empty"};let B=Pt(c,"questionId",15);var U=V(!1),t=V(Mt([])),_=V(Mt([])),W=V(Mt(P.LOADING));ue(()=>{B(),y(_,[],!0),y(U,!1),Y()});var F;function Y(){y(t,[],!0),y(W,P.LOADING,!0),F&&F.cancel();const l=B();F=ce(()=>{axios.get("/api/questions/"+B()+"/messages").then(function(u){if(l===B()){if(y(t,u.data,!0),d(t).filter(v=>!v.is_deleted).length===0){y(_,[],!0),y(W,P.EMPTY,!0);return}y(_,C(d(t)),!0)}}).catch(function(u){alert(u)})},1e3,{maxWait:2e3}),F()}function C(l){var u={},v=[];l.forEach(a=>{if(!a.parent_message_id&&!a.legacy_parent_message_id){v.push(a);return}var e=a.parent_message_id;if(!e){const r=l.find(x=>x.legacy_message_id===a.legacy_parent_message_id);r?e=r.id:console.error("Parent message not found for message",a)}u[e]||(u[e]=[]),u[e].push(a)}),Object.values(u).forEach(a=>{a.sort((e,r)=>r.thumbs_up_count-r.thumbs_down_count-(e.thumbs_up_count-e.thumbs_down_count))}),v.sort((a,e)=>e.thumbs_up_count-e.thumbs_down_count-(a.thumbs_up_count-a.thumbs_down_count));function K(a){var e=a.id;u[e]&&(a.childs=u[e],a.childs.forEach(r=>{K(r)}))}return v.forEach(a=>{K(a)}),v}function tt(l){d(t).push(l),y(_,C(d(t)),!0)}function et(l){const u=d(t).findIndex(v=>v.id===l.id);d(t)[u]=l,y(_,J(d(_),l),!0)}function J(l,u){return l.map(v=>v.id===u.id?{...u,childs:v.childs}:v.childs?{...v,childs:J(v.childs,u)}:v)}function yt(){var l={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.post("/api/questions/"+B()+"/messages",l).then(function(u){at(),d(t).push(u.data),y(_,C(d(t)),!0)}).catch(function(u){alert(u)})}function at(){y(U,!d(U)),d(U)?$.setScope("editor"):$.setScope("questions")}var lt=N(),xt=G(lt);{var ct=l=>{var u=Ce(),v=s(u);Gt(v,19,()=>d(_),r=>r.id,(r,x,E)=>{Ut(r,{indent:0,addMessage:tt,updateMessage:et,get message(){return d(_)[g(E)]},set message(w){d(_)[g(E)]=w},get questionId(){return B()},set questionId(w){B(w)}})},r=>{var x=De(),E=s(x);{var w=A=>{var L=qe();i(A,L)},X=A=>{var L=N(),st=G(L);{var p=h=>{var q=Se();i(h,q)};b(st,h=>{d(W)===P.EMPTY&&h(p)},!0)}i(A,L)};b(E,A=>{d(W)===P.LOADING?A(w):A(X,!1)})}i(r,x)});var K=n(v,2);{var a=r=>{var x=Re(),E=s(x),w=n(E,2);Et(w,"input","message"),R(w,1,"trix-content form-control mb-2"),At(w,"min-height: 4rem;");var X=n(w,2),A=n(s(X),2),L=s(A);L.__click=at;var st=n(L,2);st.__click=yt,i(r,x)},e=r=>{var x=Be(),E=ut(()=>ie(at));x.__click=function(...w){g(E)?.apply(this,w)},i(r,x)};b(K,r=>{d(U)?r(a):r(e,!1)})}i(l,u)};b(xt,l=>{c.questionContext.isAnswered&&l(ct)})}i(gt,lt),Nt()}Ot(["click"]);export{We as M};
