import{d as me,p as pe,f as C,c as w,b as ve,i as g,g as t,s as _,u as ge,t as E,e as y,h as be,a as r,aq as V,l as W,k as z,o as we}from"./render-CKlhfUir.js";import{i as I}from"./if-BNMTqS0Q.js";import{a as G}from"./attributes-BFEBEIuJ.js";import{s as he}from"./class-BfJg_ovI.js";import{s as _e}from"./style-BtOSwUPa.js";import{b as ye}from"./this-B0jBYMPO.js";import{i as qe,s as xe}from"./sql-wasm-BUfVqOaZ.js";import{l as ke}from"./lodash-d8dSvcKh.js";import"./_commonjsHelpers-CE1G-McA.js";var Re=C('<div class="alert alert-light text-truncate"><strong>Selected:</strong> </div>'),Ee=C('<div class="mt-2"><a class="btn btn-sm btn-primary">View imported deck</a></div>'),Ie=C("<div> <!></div>"),Ce=C('<span class="spinner-border spinner-border-sm me-2"></span> Importing...',1),Se=C('<div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100"><div class="progress-bar"><!></div></div>'),De=C('<button class="btn btn-sm btn-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#importOffcanvas"><i class="bi bi-upload"></i> Import deck</button> <div class="offcanvas offcanvas-end" tabindex="-1" id="importOffcanvas" aria-labelledby="importOffcanvasLabel"><div class="offcanvas-header"><h5 class="offcanvas-title" id="importOffcanvasLabel">Import deck</h5> <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button></div> <div class="offcanvas-body"><div class="mb-3"><label for="importFile" class="form-label">Select a file to import</label> <input class="form-control" type="file" id="importFile" accept=".json,.sqlite"/> <div class="form-text">Supported formats: omcarchive.json or omcarchive.sqlite</div></div> <!> <!> <div class="d-grid"><button class="btn btn-primary mb-3"><!></button> <!></div></div></div>',1);function Fe(K,X){pe(X,!0);let j,p=_(null),h=_(null),v=_(null),S=_(!1),T=_(0),Q=_(0),D=ge(()=>ke.round(t(T)/t(Q)*100)),A=_(""),M=_(null);async function Y(){return j||(j=await qe({locateFile:()=>xe})),j}async function k(e,n=4,c=5e3,a=2,l=[429,500,502,503,504]){let s=c;for(let i=0;i<=n;i++)try{return await e()}catch(o){if(!o.response||!l.includes(o.response.status)||i===n)throw o;let f=s;o.response.headers["retry-after"]&&(f=parseInt(o.response.headers["retry-after"])*1e3),console.log(`Request failed with status ${o.response.status}. Retrying in ${f}ms...`),await new Promise(b=>setTimeout(b,f)),s=s*a}}function Z(e){r(p,e.target.files[0],!0),t(p)&&(r(A,t(p).name,!0),t(p).name.endsWith(".json")?r(h,"json"):t(p).name.endsWith(".sqlite")?r(h,"sqlite"):(r(h,null),r(v,{type:"error",message:"Unsupported file format"},!0)))}async function ee(){if(!t(p)||!t(h)){r(v,{type:"error",message:"Please select a valid file"},!0);return}r(S,!0),r(T,0),r(Q,0),r(v,null);try{let e;t(h)==="json"?e=await se(t(p)):e=await te(t(p)),r(Q,e.cases.length+e.questions.length);const n={name:e.name,description:e.description,exam_at:e.exam_at||null,access:"private"},a=(await k(()=>axios.post("/api/decks",n))).data,l=[];if(e.cases&&e.cases.length>0)for(const s of e.cases){const i={name:s.name,text:s.text,deck_id:a.id},f=(await k(()=>axios.post("/api/cases",i))).data;V(T),f.export_id=s.id,l.push(f)}if(e.questions&&e.questions.length>0)for(const s of e.questions){let i=null;if(s.case_id&&l.length>0){const d=l.find(u=>u.export_id===s.case_id);d&&(i=d.id)}const o={text:s.text,hint:s.hint||null,comment:s.comment||null,type:s.type,correct_answer_id:null,is_invalid:s.is_invalid,needs_review:s.needs_review,case_id:i||null,answers:[]},b=(await k(()=>axios.post(`/api/decks/${a.id}/questions`,o))).data;if(s.images&&s.images.length>0)for(const d of s.images){const u=new FormData;u.append("image",d.blob),await k(()=>axios.post(`/api/questions/${b.id}/images`,u,{headers:{"Content-Type":"multipart/form-data"}}))}if(s.answers&&s.answers.length>0)for(const d of s.answers){const u={text:d.text,hint:d.hint||null},q=(await k(()=>axios.post(`/api/questions/${b.id}/answers`,u))).data;d.id===s.correct_answer_id&&await k(()=>axios.put(`/api/questions/${b.id}`,{correct_answer_id:q.id}))}V(T)}r(v,{type:"success",message:`Deck "${a.name.length>25?a.name.slice(0,25)+"...":a.name}" imported successfully!`,deckId:a.id},!0),r(p,null),r(h,null),t(M)&&(t(M).value="")}catch(e){r(v,{type:"error",message:e.response?.data?.message||e.message||"Import failed"},!0)}finally{r(S,!1)}}async function se(e){return new Promise((n,c)=>{const a=new FileReader;a.onload=async l=>{try{const s=JSON.parse(l.target.result);if(s.questions&&s.questions.length>0){for(const i of s.questions)if(i.images&&i.images.length>0){for(const o of i.images)if(o.base64){const f=await fetch(o.base64);o.blob=await f.blob(),delete o.base64}}}n(s)}catch{c(new Error("Invalid JSON file"))}},a.onerror=()=>c(new Error("Failed to read file")),a.readAsText(e)})}async function te(e){const n=await Y(),c=await e.arrayBuffer(),a=new n.Database(new Uint8Array(c)),l=a.exec("SELECT * FROM decks LIMIT 1");if(!l[0]||!l[0].values.length)throw new Error("No deck found in SQLite file");const s=l[0].columns,i=l[0].values[0],o={};s.forEach((d,u)=>o[d]=i[u]);const f=a.exec("SELECT * FROM cases");if(o.cases=[],f[0]){const d=f[0].columns;for(const u of f[0].values){const m={};d.forEach((q,F)=>m[q]=u[F]),o.cases.push(m)}}const b=a.exec("SELECT * FROM questions WHERE deck_id = ?",[o.id]);if(o.questions=[],b[0]){const d=b[0].columns;for(const u of b[0].values){const m={};d.forEach((x,O)=>m[x]=u[O]);const q=a.exec("SELECT * FROM images WHERE question_id = ?",[m.id]);if(m.images=[],q[0]){const x=q[0].columns,O=x.indexOf("blob");for(const L of q[0].values){const $={};for(const R of x)R==="blob"?$[R]=new Blob([L[O]],{type:"image/jpeg"}):$[R]=L[x.indexOf(R)];m.images.push($)}}const F=a.exec("SELECT * FROM answers WHERE question_id = ?",[m.id]);if(m.answers=[],F[0]){const x=F[0].columns;for(const O of F[0].values){const L={};x.forEach(($,R)=>L[$]=O[R]),m.answers.push(L)}}o.questions.push(m)}}return a.close(),o}var B=De(),ae=w(ve(B),2),oe=w(g(ae),2),J=g(oe),N=w(g(J),2);N.__change=Z,ye(N,e=>r(M,e),()=>t(M));var U=w(J,2);{var ne=e=>{var n=Re(),c=w(g(n));E(a=>W(c,` ${t(A)??""} (${a??""})`),[()=>t(h)?.toUpperCase()]),y(e,n)};I(U,e=>{t(p)&&e(ne)})}var H=w(U,2);{var ie=e=>{var n=Ie(),c=g(n),a=w(c);{var l=s=>{var i=Ee(),o=g(i);E(()=>G(o,"href",`/decks/${t(v).deckId??""}`)),y(s,i)};I(a,s=>{t(v).type==="success"&&t(v).deckId&&s(l)})}E(()=>{he(n,1,`alert alert-${t(v).type==="success"?"success":"danger"}`),W(c,`${t(v).message??""} `)}),y(e,n)};I(H,e=>{t(v)&&e(ie)})}var re=w(H,2),P=g(re);P.__click=ee;var le=g(P);{var ce=e=>{var n=Ce();y(e,n)},de=e=>{var n=z("Import deck");y(e,n)};I(le,e=>{t(S)?e(ce):e(de,!1)})}var fe=w(P,2);{var ue=e=>{var n=Se(),c=g(n),a=g(c);{var l=s=>{var i=z();E(()=>W(i,`${t(D)??""}%`)),y(s,i)};I(a,s=>{t(D)>20&&s(l)})}E(()=>{G(n,"aria-valuenow",t(D)),_e(c,`width: ${t(D)??""}%`)}),y(e,n)};I(fe,e=>{t(S)&&t(D)&&e(ue)})}E(()=>P.disabled=!t(p)||!t(h)||t(S)),y(K,B),be()}me(["change","click"]);const Oe=document.getElementById("DeckImport");we(Fe,{target:Oe});
