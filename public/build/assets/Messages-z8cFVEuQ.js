import{d as Bt,p as Ct,k as P,b as U,i as f,e as i,h as Tt,f as p,g as x,u as rt,r as u,s as J,j as s,c as r,t as V,a as w,m as bt,l as qt,n as gt}from"./if-BZUX_OG7.js";import{s as xt,d as Dt,e as Lt,i as $t,a as St,b as te,p as ee}from"./event-modifiers-Cjnfc0B6.js";import{s as j}from"./class-BfJg_ovI.js";import{s as wt}from"./style-BtOSwUPa.js";import{p as jt,a as ae,s as ne}from"./props-CMFmzDA8.js";import{r as se}from"./legacy-client-Czxnps-C.js";import{p as ie,d as re}from"./purify.es-8jJjCGTs.js";import{h as oe}from"./html-DVYBXfyI.js";import{U as de}from"./UserSettingsStore-BhF0r7c2.js";import{f as Rt,p as yt}from"./parseISO-BGu1X6cY.js";import{f as ue}from"./formatDistance-C5pjvq49.js";function le(C,e){w(e,!u(e))}function ce(C,e,y,m){var k={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.put("/api/messages/"+e().id,k).then(function(t){y(),e(e().text=t.data.text,!0),e(e().is_anonymous=t.data.is_anonymous,!0),e(e().updated_at=t.data.updated_at,!0),m.updateMessage(e())}).catch(function(t){alert(t)})}function ve(C,e,y){var m={text:document.getElementById("replyMessage").value,parent_message_id:document.getElementById("parentMessageId").value,is_anonymous:document.getElementById("replyAnonymous").checked};axios.post("/api/questions/"+e.questionId+"/messages",m).then(function(k){y(),e.addMessage(k.data)}).catch(function(k){alert(k)})}function _e(C,e,y){confirm("Are you sure you want to delete this message?")&&axios.delete("/api/messages/"+e().id).then(function(m){e(e().text="",!0),e(e().is_deleted=!0,!0),y.updateMessage(e())}).catch(function(m){alert(m)})}var me=p('<div class="p-2"><button class="btn btn-link btn-sm text-muted p-0"><i class="bi bi-eye-slash me-1"></i>Comment hidden due to low rating. Click to show.</button></div>'),be=p('<div class="p-2"><span class="text-muted small"><i class="bi bi-trash me-1"></i>This comment has been deleted.</span></div>'),fe=(C,e)=>e("up"),pe=(C,e)=>e("down"),he=p('<i class="bi bi-arrow-return-right" title="Answer"></i> <span>•</span>',1),ge=p('<i class="bi bi-incognito" title="Anonymous"></i>'),ye=p('<i class="bi bi-pencil ms-1"></i>'),xe=p('<div class="trix-content pe-4"><!></div>'),we=p('<div class="pe-2"><input id="message" type="hidden" name="message"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous"/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),ke=p('<div class="dropdown"><button class="btn btn-link p-0 text-muted me-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button> <ul class="dropdown-menu dropdown-menu-end"><li><button class="dropdown-item"><i class="bi bi-pencil me-2"></i>Edit</button></li> <li><button class="dropdown-item"><i class="bi bi-trash me-2"></i>Delete</button></li></ul></div>'),Me=p('<div class="d-flex align-items-end gap-2 pe-1"><button title="Reply"><i class="bi bi-reply"></i></button> <!></div>'),Ie=p('<div><div class="d-flex flex-column gap-1" style="min-width: 2rem"><button><i></i></button> <span class="text-center text-muted small"> </span> <button><i></i></button></div> <div class="flex-grow-1"><div class="d-flex gap-2 text-muted small"><!> <span><!></span> <span>•</span> <span> <!></span></div> <div class="mt-1"><!></div></div> <!></div>'),Ee=p('<i class="bi bi-incognito" title="Anonymous"></i>'),Ae=p('<div class="border-start border-2 my-2 ms-2 ps-2"><div class="d-flex gap-2 text-muted small mb-2"><i class="bi bi-arrow-return-right" title="Answer"></i> Replying to <!></div> <div><input id="replyMessage" type="hidden" name="replyMessage"/> <input id="parentMessageId" type="hidden" name="parentMessageId"/> <trix-editor></trix-editor> <div class="d-flex justify-content-between"><div class="form-check"><input type="checkbox" class="form-check-input" id="replyAnonymous" checked/> <label class="form-check-label small" for="replyAnonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Reply</button></div></div></div></div>',2),qe=p("<div><!> <!> <!></div>");function Ot(C,e){Ct(e,!0);const y=()=>ne(de,"$UserSettings",m),[m,k]=ae();let t=jt(e,"message",15),v=rt(()=>t().thumbs.find(n=>n.user_id!==void 0)??null),T=rt(()=>t().thumbs_up_count-t().thumbs_down_count>4),K=rt(()=>t().thumbs_up_count-t().thumbs_down_count<-2);var X=J(!1),Y=J(!1),ot=J(!1);function et(){w(X,!u(X))}function Z(){w(Y,!u(Y))}function $(n){x(v)!==null?x(v).type===n?axios.delete("/api/messages/"+t().id+"/thumbs/"+x(v).id).then(function(a){t(t().thumbs=t().thumbs.filter(B=>B.user_id===void 0),!0),t(n==="up"?t().thumbs_up_count-=1:t().thumbs_down_count-=1,!0),e.updateMessage(t())}).catch(function(a){alert(a)}):axios.put("/api/messages/"+t().id+"/thumbs/"+x(v).id,{type:n}).then(function(a){t().thumbs.find(B=>B.user_id!==void 0).type=n,n==="up"?(t(t().thumbs_up_count+=1,!0),t(t().thumbs_down_count-=1,!0)):(t(t().thumbs_down_count+=1,!0),t(t().thumbs_up_count-=1,!0)),e.updateMessage(t())}).catch(function(a){alert(a)}):axios.post("/api/messages/"+t().id+"/thumbs",{type:n}).then(function(a){t().thumbs.push({type:a.data.type,user_id:a.data.user_id,id:a.data.id}),t(n==="up"?t().thumbs_up_count+=1:t().thumbs_down_count+=1,!0),e.updateMessage(t())}).catch(function(a){alert(a)})}function at(n){return Array.isArray(n.childs)?n.childs.some(a=>!a.is_deleted||at(a)):!1}var dt=P(),ft=U(dt);{var h=n=>{var a=qe();let B;var l=s(a);{var g=d=>{var b=me(),S=s(b);S.__click=[le,ot],i(d,b)},c=d=>{var b=P(),S=U(b);{var W=A=>{var H=be();i(A,H)},O=A=>{var H=Ie(),F=s(H),N=s(F);let ut;N.__click=[fe,$];var pt=s(N);let st;var lt=r(N,2),z=s(lt),Q=r(lt,2);let ct;Q.__click=[pe,$];var ht=s(Q);let tt;var it=r(F,2),kt=s(it),Mt=s(kt);{var Ht=o=>{var _=he();i(o,_)};f(Mt,o=>{e.indent>0&&o(Ht)})}var It=r(Mt,2),Nt=s(It);{var Gt=o=>{var _=ge();i(o,_)},Pt=o=>{var _=P(),E=U(_);{var q=D=>{var R=qt();V(()=>bt(R,t().author.public_name||t().author.name)),i(D,R)};f(E,D=>{t().author&&D(q)},!0)}i(o,_)};f(Nt,o=>{t().is_anonymous?o(Gt):o(Pt,!1)})}var Et=r(It,4),At=s(Et),Ut=r(At);{var Yt=o=>{var _=ye();V(E=>St(_,"title",E),[()=>"Edited "+Rt(yt(t().updated_at),"dd.MM.yyyy HH:mm")]),i(o,_)};f(Ut,o=>{t().updated_at!==t().created_at&&o(Yt)})}var zt=r(kt,2),Qt=s(zt);{var Vt=o=>{var _=xe(),E=s(_);{var q=D=>{var R=P(),G=U(R);oe(G,()=>ie.sanitize(t().text)),i(D,R)};f(E,D=>{t().text&&D(q)})}i(o,_)},Wt=o=>{var _=we(),E=s(_),q=r(E,2);xt(q,"input","message"),j(q,1,"trix-content form-control mb-2"),wt(q,"min-height: 4rem;");var D=r(q,2),R=s(D),G=s(R),vt=r(R,2),_t=s(vt);_t.__click=et;var mt=r(_t,2);mt.__click=[ce,t,et,e],V(()=>{Dt(E,t().text),te(G,t().is_anonymous)}),i(o,_)};f(Qt,o=>{u(X)?o(Wt,!1):o(Vt)})}var Ft=r(it,2);{var Jt=o=>{var _=Me(),E=s(_);let q;E.__click=Z;var D=r(E,2);{var R=G=>{var vt=ke(),_t=r(s(vt),2),mt=s(_t),Kt=s(mt);Kt.__click=et;var Xt=r(mt,2),Zt=s(Xt);Zt.__click=[_e,t,e],i(G,vt)};f(D,G=>{y().id===t().author_id&&G(R)})}V(G=>q=j(E,1,"btn btn-link p-0 text-muted me-1",null,q,G),[()=>({disabled:u(Y)})]),i(o,_)};f(Ft,o=>{u(X)||o(Jt)})}V((o,_,E,q,D,R)=>{j(H,1,`d-flex gap-1 mb-2 message-content ${x(T)?"bg-light rounded-end-3 shadow-sm py-2 ps-1 pe-2 ms-1":"py-1 rounded-end-3"}`),ut=j(N,1,"btn btn-link p-0 text-muted text-decoration-none",null,ut,o),st=j(pt,1,"bi",null,st,_),bt(z,t().thumbs_up_count-t().thumbs_down_count),ct=j(Q,1,"btn btn-link p-0 text-muted text-decoration-none",null,ct,E),tt=j(ht,1,"bi",null,tt,q),St(Et,"title",D),bt(At,`${R??""} `)},[()=>({disabled:t().is_deleted}),()=>({"bi-hand-thumbs-up-fill":x(v)?.type==="up","bi-hand-thumbs-up":x(v)?.type!=="up"}),()=>({disabled:t().is_deleted}),()=>({"bi-hand-thumbs-down-fill":x(v)?.type==="down","bi-hand-thumbs-down":x(v)?.type!=="down"}),()=>Rt(yt(t().created_at),"dd.MM.yyyy HH:mm"),()=>ue(yt(t().created_at),new Date,{addSuffix:!0})]),i(A,H)};f(S,A=>{t().is_deleted?A(W):A(O,!1)},!0)}i(d,b)};f(l,d=>{x(K)&&!u(ot)?d(g):d(c,!1)})}var M=r(l,2);{var L=d=>{var b=Ae(),S=s(b),W=r(s(S),2);{var O=z=>{var Q=Ee();i(z,Q)},A=z=>{var Q=P(),ct=U(Q);{var ht=tt=>{var it=qt();V(()=>bt(it,t().author.public_name||t().author.name)),i(tt,it)};f(ct,tt=>{t().author&&tt(ht)},!0)}i(z,Q)};f(W,z=>{t().is_anonymous?z(O):z(A,!1)})}var H=r(S,2),F=r(s(H),2),N=r(F,2);xt(N,"input","replyMessage"),j(N,1,"trix-content form-control mb-2"),wt(N,"min-height: 4rem;");var ut=r(N,2),pt=r(s(ut),2),st=s(pt);st.__click=Z;var lt=r(st,2);lt.__click=[ve,e,Z],V(()=>Dt(F,t().id)),i(d,b)};f(M,d=>{u(Y)&&d(L)})}var I=r(M,2);{var nt=d=>{var b=P(),S=U(b);Lt(S,17,()=>t().childs,$t,(W,O)=>{var A=P(),H=U(A);{let F=rt(()=>e.indent+1);Ot(H,{get message(){return x(O)},get indent(){return x(F)},get addMessage(){return e.addMessage},get updateMessage(){return e.updateMessage},get questionId(){return e.questionId}})}i(W,A)}),i(d,b)};f(I,d=>{t().childs&&d(nt)})}V(d=>B=j(a,1,"border-start border-2",null,B,d),[()=>({"ms-2":e.indent>0,"mb-3":!e.indent})]),i(n,a)};f(ft,n=>{(!t().is_deleted||at(t()))&&n(h)})}i(C,dt),Tt(),k()}Bt(["click"]);function De(C,e,y,m,k,t){var v={text:document.getElementById("message").value,is_anonymous:document.getElementById("anonymous").checked};axios.post("/api/questions/"+e()+"/messages",v).then(function(T){y(),u(m).push(T.data),w(k,t(u(m)),!0)}).catch(function(T){alert(T)})}var Se=p('<div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading messages ...</span></div>'),Re=p('<div class="text-muted">No comments yet. Be the first to leave a comment!</div>'),Be=p('<div class="mb-3 d-flex justify-content-center"><!></div>'),Ce=p('<div class="mt-3 border-top border-2 pt-3"><input id="message" type="hidden" name="message" value=""/> <trix-editor></trix-editor> <div class="d-flex justify-content-between pb-1"><div class="form-check"><input type="checkbox" class="form-check-input" id="anonymous" checked/> <label class="form-check-label small" for="anonymous">Anonymous</label></div> <div class="d-flex gap-2"><button class="btn btn-link btn-sm text-muted text-decoration-none p-0">Cancel</button> <button class="btn btn-primary btn-sm py-0">Save</button></div></div></div>',2),Te=p('<button class="btn btn-sm btn-outline-secondary"><i class="bi bi-chat-square-text"></i> Add comment</button>'),Le=p('<div class="mt-4 mb-3 px-2 py-2 border rounded-3 shadow-sm bg-white"><!> <!></div>');function We(C,e){Ct(e,!0);const y={LOADING:"loading",EMPTY:"empty"};let m=jt(e,"questionId",15);var k=J(!1),t=J(gt([])),v=J(gt([])),T=J(gt(y.LOADING));se(()=>{m(),w(v,[],!0),w(k,!1),X()});var K;function X(){w(t,[],!0),w(T,y.LOADING,!0),K&&K.cancel();const h=m();K=re(()=>{axios.get("/api/questions/"+m()+"/messages").then(function(n){if(h===m()){if(w(t,n.data,!0),u(t).filter(a=>!a.is_deleted).length===0){w(v,[],!0),w(T,y.EMPTY,!0);return}w(v,Y(u(t)),!0)}}).catch(function(n){alert(n)})},1e3,{maxWait:2e3}),K()}function Y(h){var n={},a=[];h.forEach(l=>{if(!l.parent_message_id&&!l.legacy_parent_message_id){a.push(l);return}var g=l.parent_message_id;if(!g){const c=h.find(M=>M.legacy_message_id===l.legacy_parent_message_id);c?g=c.id:console.error("Parent message not found for message",l)}n[g]||(n[g]=[]),n[g].push(l)}),Object.values(n).forEach(l=>{l.sort((g,c)=>c.thumbs_up_count-c.thumbs_down_count-(g.thumbs_up_count-g.thumbs_down_count))}),a.sort((l,g)=>g.thumbs_up_count-g.thumbs_down_count-(l.thumbs_up_count-l.thumbs_down_count));function B(l){var g=l.id;n[g]&&(l.childs=n[g],l.childs.forEach(c=>{B(c)}))}return a.forEach(l=>{B(l)}),a}function ot(h){u(t).push(h),w(v,Y(u(t)),!0)}function et(h){const n=u(t).findIndex(a=>a.id===h.id);u(t)[n]=h,w(v,Z(u(v),h),!0)}function Z(h,n){return h.map(a=>a.id===n.id?{...n,childs:a.childs}:a.childs?{...a,childs:Z(a.childs,n)}:a)}function $(){w(k,!u(k))}var at=P(),dt=U(at);{var ft=h=>{var n=Le(),a=s(n);Lt(a,19,()=>u(v),c=>c.id,(c,M,L)=>{Ot(c,{indent:0,addMessage:ot,updateMessage:et,get message(){return u(v)[x(L)]},set message(I){u(v)[x(L)]=I},get questionId(){return m()},set questionId(I){m(I)}})},c=>{var M=Be(),L=s(M);{var I=d=>{var b=Se();i(d,b)},nt=d=>{var b=P(),S=U(b);{var W=O=>{var A=Re();i(O,A)};f(S,O=>{u(T)===y.EMPTY&&O(W)},!0)}i(d,b)};f(L,d=>{u(T)===y.LOADING?d(I):d(nt,!1)})}i(c,M)});var B=r(a,2);{var l=c=>{var M=Ce(),L=s(M),I=r(L,2);xt(I,"input","message"),j(I,1,"trix-content form-control mb-2"),wt(I,"min-height: 4rem;");var nt=r(I,2),d=r(s(nt),2),b=s(d);b.__click=$;var S=r(b,2);S.__click=[De,m,$,t,v,Y],i(c,M)},g=c=>{var M=Te(),L=rt(()=>ee($));M.__click=function(...I){x(L)?.apply(this,I)},i(c,M)};f(B,c=>{u(k)?c(l):c(g,!1)})}i(h,n)};f(dt,h=>{e.questionContext.isAnswered&&h(ft)})}i(C,at),Tt()}Bt(["click"]);export{We as M};
